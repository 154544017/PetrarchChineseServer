<center>

# ARM926EJ-S芯片技术手册学习笔记

**王菲凡  
1751694**

</center>

[toc]

## 选择理由及ARM926EJ-S处理器简介

ARM926EJ-S处理器是ARM​​9通用系列的成员微处理器。ARM926EJ-S处理器主要针对多任务应用。在多任务应用的管理中，全面的内存管理，高性能，低裸片尺寸和低功耗都十分重要。

ARM926EJ-S宏单元是全面可合成的，并且它具有一款Jazelle技术增强型32位RISC CPU，容量灵活可变的指令和数据缓存，紧耦合存储器（TCM）接口和存储器管理单元（MMU）。它还提供了独立的指令和数据AMBA总线规范AHB接口，特别适合基于多层AHB的系统。ARM926EJ-S内核实现了ARMv5TEJ指令集，且包含一个增强型16x32位乘法器，能够在一个时钟周期内完成MAC运算。ARMv5TEJ指令集包括16位定点DSP指令，可以增强许多信号处理算法和应用的性能，并支持Thumb和Java字节码的执行。

该处理器多应用于：

* 下一代智能手机、通信设备和PDA
* 3G基带和应用处理器
* 基于平台操作系统的设备
* 数码照相机
* 音频和视频解码
* 
汽车信息娱乐系统 

虽然该款处理器较老，但架构成熟，支持完善，支持包括Symbian OS、Windows CE和Linux在内的多种操作系统的MMU。如今在功能较为单一的嵌入式设备上仍有较为广泛的应用。

## 内存管理单元

### MMU介绍

ARM926EJ-S的内存管理单元是ARM架构v5 MMU。它在Symbian OS，WindowsCE，和Linux等操作系统上运行时，具有虚拟内存管理功能。存储在主存储器中的一组两级页表用于控制地址转换，权限检查以及数据和指令访问的存储器区域属性。

该MMU使用一个统一的页表缓存（Translation Lookaside Buffer，TLB）来缓存页表中保存的信息。MMU将转义后的物理地址存入TLB。

该处理器MMU的TLB分为两个部分：主TLB和锁定TLB。前者是用于页表信息的双路集关联高速缓存，后者是八项完全关联的高速缓存，其中包含锁定的TLB条目。锁定TLB可以确保对给定区域的内存访问不会引起页表遍历的损失。

#### 访问权限和域

内存的所有区域都有一个关联的域。域是内存区域的主要访问控制机制。它定义了进行访问所需的条件。域确定是否：

* 访问权限用于限定访问权限
* 无条件允许访问
* 访问无条件终止

#### 转义条目

主TLB缓存64个转换后的条目。如果在内存访问期间主TLB包含MVA的转义条目，则MMU读取保护数据以确定是否允许访问：

* 如果访问被允许并且需要访问片外存储器中，MMU输出对应于MVA适当的物理地址
* 如果允许访问并且不需要片外访问，则高速缓存或TCM将为访问提供服务
* 如果不允许访问，则MMU发出信号通知CPU内核中止

### 地址的转换

FCSE使用CP15 c13中保存的值将CPU内核生成的VA转换为修改后的虚拟地址（Modified Virtual Address，MVA）。 MMU将MVA转换为物理地址以访问外部存储器，并执行访问权限检查。

MMU表遍历硬件用于将条目添加到TLB。包括地址转换数据和访问许可数据的转换信息驻留在位于物理存储器中的转换表中。 MMU提供了自动遍历此转换表并将条目加载到TLB的逻辑。

硬件表遍历和权限检查过程中的阶段数为一或两个，具体取决于该地址是标记为段映射访问还是页映射访问。

翻译过程始终以相同的方式开始，并进行一级读取。段映射访问仅需要一级访存，而页映射访问则需要额外的二级访存。

#### 页表的转换

当TLB不包含所请求的MVA的翻译时，将启动硬件翻译过程。转换表基址寄存器（TTBR）CP15寄存器c2指向物理存储器中包含段或页描述符或两者的表的基地址。 TTBR的14个低位[13：0]在读取时是不可预测的，并且该表必须位于16KB边界上。 TTBR的格式如图3-1所示：

![3-1](img_arm/3-1)

整个走表过程如图3-2所示：

![3-2](img_arm/3-2)

#### 一级提取

TTBR的位[31:14]与MVA的位[31:20]并置以产生30位地址。

#### 一级描述符

![3-4](img_arm/3-4)

如图，其中段描述符提供1MB内存块的基地址，页表描述符提供包含第二级描述符的页表的基地址。

一级描述符指示页面大小和有效性的任务由低两位完成。

#### 段描述符

![3-5](img_arm/3-5)

在[8-5]位指定域，包括对域的访问控制。内存的缓冲类型则由[3-2]位决定。

#### 粗页表描述符

![3-6](img_arm/3-6)

同样由[8-5]位指定域，但[4]始终写1，[3-2]始终写0，[1:0]保持01以指示粗页表描述符。

**值得注意的是，粗页表描述符的工作机制与其他描述符相比有所不同：如果从第一级提取返回了粗页表描述符，则将启动第二级提取。**

#### 细页表描述符

![3-7](img_arm/3-7)

精细页面表描述符提供页面表的基地址，该页面表包含用于大页，小页或小页访问的二级描述符。细页表具有1024个条目，将表描述的1MB拆分为1KB块。

**与粗页表描述符相似：如果从第一级提取返回了细页表描述符，则将启动第二级提取。**

#### 二级描述符

如果**第一级提取返回粗页表描述符或细页表描述符**，则这将提供要使用的页表的基地址。访问页表，并返回第二级描述符。

![3-9](img_arm/3-9)

二级描述符定义了一个微小，小或大的页描述符，或者是无效的：

* 大的页描述符提供64KB内存块的基址
* 小的页描述符提供4KB内存块的基址
* 微小的页描述符提供1KB内存块的基地址

其中描述符的类型由
二级描述符的低2位指示。

#### 描述符权限

综上可以看出，在一级描述中指定的域和在一级描述中指定的访问权限一起确定访问是否具有进行权限。

### MMU故障和CPU中断

以下故障将导致MMU中断：

* 对齐错误（只数据访问）（alignment faults）
* 转义错误（translation faults）
* 域错误（domain faults）
* 权限错误（permission faults）

外部系统可以引发外部异常中断：

* 走页表（page walks）
* 非缓存读（noncached reads）
* 非缓冲写（nonbuffered writes）
* 非缓存的读锁写序列（non cached read-lock-write sequence，SWP）

**需注意：在外部异常中断中，只有将核心与外部系统同步的访问类型才能发生这种情况。**

MMU的访问控制机制可检测产生这些故障的条件。如果由于访问存储器而检测到故障，则MMU会中止访问，并将故障情况通知CPU内核。 MMU在数据故障状态寄存器和故障地址寄存器中保留有关由数据访问产生的故障的状态和地址信息。

**指令侧中止的地址信息包含在核心链接寄存器r14_abt中。**

给定内存访问的访问冲突会禁止对AHB接口的任何相应外部访问，并且中断返回到CPU内核。

#### 故障地址和故障状态寄存器

在数据中断时，MMU在数据故障状态寄存器（Fault status register，FSR）中放置一个编码的四位值，故障状态以及四位编码的域号。同样，在“预取中止”中，指令FSR仅用于调试目的。另外，与数据中断关联的MVA被锁存在故障地址寄存器（Fault address register，FAR）中。如果访问冲突同时产生多个中断源，则会按照下表中给出的优先级对它们进行编码。指令预取引起的错误不会更新FAR。


![3-9t](img_arm/3-9t)

**对此：**

* **对齐错误可将b0001或b0011写入FSR[3:0]**
* **域错误的状态位编码中可能出现无效值（如在从页表描述中读取有效域字段之前引发故障时，就会发生这种情况）**
* **可以通过修复较高优先级中断的原因并重复访问来重新生成较高优先级中断所掩盖的中断**
* **对齐错误对于指令提取是不可能的**
* **指令FSR也可以针对指令预取操作进行更新**

而FAR用于加载和存储可能涉及多个单词传输的指令（LDM / STM，LDRD，STRD和STC / LDC），将值写入FAR寄存器取决于访问类型，对于外部中断，取决于访问是否越过1KB边界。

### 域权限控制

MMU的访问主要通过域的使用来控制。域是在域访问控制寄存器中定义的。

域的位与访问权限的关系：

![3-11t](img_arm/3-11t)

访问权限（AP）位以及它们的解释取决于R和S位，控制寄存器c1位[9：8]

![3-12t](img_arm/3-12t)

### 故障处理

#### 对齐错误

如果启用了对齐错误检查（CP15 c1中的A位置1），则MMU在地址未字对齐的情况下在任何数据字访问中生成对齐错误，在地址未在半字对齐中进行时在任何半字访问时生成对齐错误。 无论是否启用了MMU。取指令或字节访问均不会产生对齐错误。

**如果访问产生对齐错误，则访问序列将中止而不参考其他权限检查。**

#### 转义错误

分为两种类型：

* 段错误：如果将一级描述符标记为无效，则会生成段转义错误。（如描述符的位[1:0]都为0，发生这种情况）
* 页错误：如果将第一级描述符标记为无效，则会生成页面转换错误。（如果描述符的位[1:0]都为0，发生这种情况）

#### 域错误

同样分为段错误和页错误。如果指定的访问权限为无访问权限（00）或保留访问权限（10），则将发生域的段故障或域的页故障。

#### 权限错误

当需要某段映射访问或页映射访问时，访问被拒绝，则发生权限错误。且由此分为段的权限错误和页的权限错误。

### 外部中断

对于之前提到的四个中断中的SWP序列，如果读取从外部中止，则写入始终为尝试（attempted）。

#### 启用MMU

在使用CP15 c1启用MMU之前，必须：

1. 对TTB寄存器（CP15 c2）和域访问控制寄存器（CP15 c3）进行编程。
2. 根据需要对第一级和第二级页表进行编程，确保将有效的转换表放在TTB寄存器指定的位置的内存中。

**由于同一寄存器CP15 c1控制ICache，DCache和MMU的启用，因此可以使用单个MCR指令来启用全部三个。**

#### 禁用MMU

清除CP15 c1中的位0即可禁用MMU。

**如果启用了MMU，然后将其禁用，然后重新启用，则将保留TLB的内容。如果这些现在无效，则必须在重新启用MMU之前使TLB无效。**

## Cache高速缓存和写缓冲

ARM926EJ-S处理器包括：

* 一个指令高速缓存Cache（ICache）
* 一个数据高速缓存Cache（DCache）
* 一个写缓冲区

缓存的大小可以从4KB到128KB，以2为增量。

Cache具有以下特性：

* 缓存是虚拟索引，虚拟标记，使用修改的虚拟地址（Modified Virtual Address，MVA）进行寻址。这使得能够避免缓存清理和/或上下文切换无效
* 高速缓存是四组关联的，高速缓存的行长为每行8个字，32个字节，DCache中有两个脏位
* Cache支持通过存储区使用MMU转换表中的C和B位选择的直写和回写或回写缓存操作
* 支持在未命中时分配。缓存执行关键词优先缓存重新填充
* 伪随机或循环替换，可由CP15 c1中的RR位选择
* 高速缓存锁定寄存器能够控制在行填充上分配哪种高速缓存方式，从而提供锁定和控制高速缓存污染的机制
* 除了存储在标记RAM中的虚拟地址标记之外，DCache还将与每个DCache条目相对应的物理地址（PA）标记存储在标记RAM中，以便在回写高速缓存期间使用。这意味着MMU不参与DCache回写操作，从而消除了与回写地址相关的TLB丢失的可能性
* PLD数据预加载指令不会导致数据高速缓存换行。它被视为NOP指令
* 缓存维护操作可提供有效的失效：
	* 整个DCache或ICache
	* DCache或ICache的区域
	* 虚拟内存区域
	* ------------分割线---------------
	* 整个DCache
	* Dcache的区域
	* 虚拟内存的区域

**分割线以下的操作使DCac​​he一致性能够在发生小的代码更改时（例如用于自修改代码和对异常向量的更改）得到有效维护。**

### 写缓冲

写缓冲区用于对不可缓存，可缓冲区域，直写区域的所有写操作，以及对写回区域的写未命中。 
DCache中包含一个单独的缓冲区，用于保存回写数据以用于缓存行逐出或清除脏缓存行。

主写缓冲区具有一个16字数据缓冲区和一个四地址缓冲区。 

DCache回写缓冲区具有八个数据字条目和一个地址条目。 

MCR清空写缓冲区指令使两个写缓冲区都可以在软件控制下清空。

MCR等待中断会导致两个写缓冲区都耗尽，并且ARM926EJ-S处理器将进入低功耗状态，直到发生中断为止。


对于在写缓冲区中具有相应挂起写操作的读访问，不会进行任何转发。对于此类访问，将清空写缓冲区，并从外部存储器中获取值。

### 启用Cache

重置时，ICache和DCache条目均无效，并且禁用了缓存。不能访问高速缓存进行读取或写入。使用CP15 c1中的I，C和M位启用高速缓存，可以独立地启用高速缓存。

### TCM和缓存访问优先级

下表显示了适用于ARM926EJ-S处理器的指令访问优先级。 

![4-5t](img_arm/4-5t)

ARM926EJ-S处理器为指令TCM区域中的地址赋予最高优先级。

### Cache MVA和设置/方式格式

下图为一个通用的，虚拟索引的，虚拟寻址的Cache。

![4-1](img_arm/4-1)

而ARM926EJ-S的Cache样式如下图所示。

![4-2](img_arm/4-2)

ARM926EJ-S的Cache的S和NSETS值则为：

![4-7t](img_arm/4-7t)

由以上信息可知，在ARM926EJ-S的Cache中：

* 相同索引的标签组定义一个Set
* Set中标签的数量具有相联性
* ARM926EJ-S缓存是四路关联的
* 索引处理的标签范围定义了一路

ARM926EJ-S缓存的Set / Way / Word格式为：

![4-3](img_arm/4-3)

**A = log<sub>2</sub>相联度**

## 总线接口单元

ARM926EJ-S总线接口单元（BIU）仲裁和调度AHB请求。 BIU包含用于指令和数据访问的独立主机，从而实现了完整的AHB系统灵活性。独立的主机可实现多层AHB和多层AHB系统，从而带来了增加的总总线带宽和更灵活的系统架构的好处。每个主机都是完全兼容的AHB总线主机，并实现AMBA规范（Rev 2.0）中定义的主机功能。

### 支持的AHB转移

ARM926EJ-S处理器支持AHB传输的子集。

#### 内存映射

ARM926EJ-S处理器是具有两个AHB接口的缓存处理器。一个关键的系统设计问题是D侧必须能够与I侧使用相同的内存映射访问相同的内存。这不仅需要加载代码，而且还需要访问相对PC的文字池，并使SWI和仿真指令处理程序正常工作。

**这与某些Harvard arrangements不同，在Harvard arrangements中，I总线可以连接到ROM，而D总线仅可以连接到RAM /外围设备。**

#### 传输大小

ARM926EJ-S处理器以单个字节，单个半字，单个字，四个字的burst（AXI总线协议里基本的数据传输形式）或八个字的burst执行所有AHB访问。任何大小不是1、4或8个字的ARM9EJ-S核心请求都将分成这些大小的数据包。例如，在AHB上执行12字的STM，作为8字burst，然后是4字burst。如果由于Split或Retry响应或通过删除HGRANT而中断了burst，则burst完成作为单次转移。因此，ARM926EJ-S处理器仅使用可能的HBURST和HSIZE编码的子集。

**Incr4和Incr8 burst可以与任何字边界对齐。 ARM926EJ-S处理器在AHB上以全字传输方式执行所有Thumb指令提取。**

所有突发读取和写入均由ARM926EJ-S处理器执行字宽传输（HSIZE [2:0] = 010）。单次读取和写入按字节（HSIZE [2:0] = 000），半字（HSIZE [2:0] = 001）或字宽传输（HSIZE [2:0] = 010）执行。

**ARM926EJ-S处理器不会在DHTRANS或IHTRANS上生成BUSY的传输**

#### 一级和二级AHB属性的映射

内存操作的IHPROT [3:0]和DHPROT [3:0]映射：

![6-2t](img_arm/6-2t)

如果访问是由内核的特权访问引起的，则P为1；如果是用户访问引起的，则为0。

**DCache写回可能由换行期间的逐出或显式的缓存清除操作引起。**

#### 字节和半字访问

##### 地址对齐

ARM926EJ-S BIU执行地址对齐检查，并将AHB地址对齐到必要的边界。 16位访问与半字边界对齐，而32位访问与字边界对齐。

##### Thumb指令获取

不论ARM9EJ-S内核的状态如何，所有指令提取均作为AHB上的32位访问进行。如果ARM9EJ-S内核处于Thumb状态，则可以一次提取两条指令。

##### 字节序和字节通道指示

AMBA规范（Rev 2.0）未指定对字节序的任何明确支持。 ARM926EJ-S处理器提供一个补充信号DHBL，该信号指示要为写传输更新哪些字节，以及哪些字节必须包含有效数据以进行读取。这是使用地址和访问的字节序创建的。

由于写入是缓冲的，因此如果在更改控制寄存器的字节序设置之前未清空写入缓冲区，则CFGBIGEND信号的值可能与DHBL不一致。

#### AHB系统

##### 单层AHB系统

将两个ARM926EJ-S总线主控器集成到单层AHB系统中的最简单方法是，将每个主控器作为单独的请求者放入AHB仲裁器中，这与任何多主控器系统相同。数据主机通常比指令主机具有更高的仲裁优先级。

ARM926EJ-S指令的AHB接口不会执行锁定的传输，因此IHLOCK始终被驱动为LOW。

##### 多层AHB系统

多层AHB系统示例：

![6-1](img_arm/6-1)

标记为I-side的I接口和标记为D-side的D接口通过互连矩阵配置为可以访问四个从端口。如果两个AHB接口（称为层）需要同时访问同一从属设备，则互连矩阵内的仲裁过程将确定优先级最高的层。在此系统下，D端可以访问I端当时未使用的任何从端口。这增加了可用的总体总线带宽。

##### 多AHB系统

多AHB系统示例：

![6-2](img_arm/6-2)

尽管必须有一种机制来支持对指令存储器的数据侧访问，但ARM926EJ-S指令和数据AHB接口可能可以连接到单独的AHB系统。每个AHB系统可以以不同的频率运行。 ARM926EJ-S处理器可以通过提供两个HCLKEN输入来解决此问题：

* DHCLKEN用于指定数据BIU为主机的系统的HCLK上升沿
* IHCLKEN用于为指令BIU为主机的系统指定HCLK的上升沿

如果两个AHB系统以相同的频率运行，则必须将DHCLKEN和IHCLKEN连接在一起。

##### 内存一致性

由于ARM926EJ-S处理器的Havard特性，不能保证指令和数据流的顺序，并且可以将两个主机的仲裁顺序视为任意的。

#### AHB时钟

ARM926EJ-S设计使用单个时钟CLK。要以比AHB系统总线更高的频率运行ARM926EJ-S处理器，需要为两个总线主控器中的每一个单独的AHB时钟使能。在多AHB系统中，每个AHB系统都可以不同的频率运行：

![6-3](img_arm/6-3)

上图为AHB时钟关系的示意图。对于单层和多层AHB系统，必须将DHCLKEN和IHCLKEN连接在一起。如果HCLK和CLK频率相同，则必须将相关的HCLKEN输入或多个输入捆绑为HIGH。 CLK和HCLK必须同步。 CLK和HCLK之间的偏斜必须最小化。

#### 外部中断限制

如果针对AHB传输返回错误响应，则仅某些类型的访问会导致外部中断：

* 页表走（page table walk）
* 非缓存读
* 非缓冲写
* 非缓存读锁写（SWP）

对于所有其他类型的访问（缓存行填充，回写逐出，缓冲的写操作），将忽略错误响应。

**如果要在必须容忍外部存储器中的软错误的系统中使用ARM926EJ-S处理器，则在进行AHB传输时，必须在硬件中同时进行软错误检测和纠正。** 

## 一些体会

在ARM926EJ-S技术手册的阅读中，我主要认真研读了内存管理、Cache和buffer相关以及总线接口部分等模块。在感受到ARM处理器精妙的同时，也感受到了所学知识都融合起来的强大。在学习过程中，也写下了自己的总结和看法，不可避免有所疏漏和错误之处。

在学习过程中，我加深了对内存管理机制的理解，对中断和缓存等机制有了更深的了解。而之前的课程中很少涉及总线部分的学习，因此也挑选了一个关于总线的模块进行了解，感觉仿佛打开了一个新世界。不断查阅专业术语的过程中，对总线的工作机理也有了浅浅的认知。

所学愈为丰富，则所见愈加广阔。



### 附录

1. [技术手册地址（http://infocenter.arm.com/help/topic/com.arm.doc.ddi0198e/DDI0198E_arm926ejs_r0p5_trm.pdf）](http://infocenter.arm.com/help/topic/com.arm.doc.ddi0198e/DDI0198E_arm926ejs_r0p5_trm.pdf)
2. [官方文档网址（http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0222b/index.html）](http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0222b/index.html)