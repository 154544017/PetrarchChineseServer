
<center>
# Android 系统分析

**1751694  
王菲凡**
</center>

[toc]

<div style="page-break-after:always"> </div>

## 架构分析

Android大致可以分为四层架构：Linux内核层、系统运行库层、应用框架层和应用层。

在最底层，Android使用了Linux内核，从而能够利用起Linux已有的丰富的硬件支持（由于版权原因，Android在Linux内核之上使用了完全不同的架构）。在Linux内核之上，Android选择使用Java进行各项API的开发，因此制作了适宜移动端使用的Dalvik虚拟机（现在已被更快的ART所取代），从而向上提供系统运行库。再往上则是丰富的应用程序框架层，最上层则是丰富的应用程序；利用Java跨平台的性质，基于Android框架开发的应用程序可以不用编译运行于任何一台安装有android系统的平台，这可以说是Android的精髓所在。

<img src="https://upload-images.jianshu.io/upload_images/14515742-e9fa23aff7831bc6.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200" width=600 align=center>

### Linux内核层

Android系统是基于Linux内核的，这一层为Android设备的各种硬件提供了底层的驱动（如显示，音频，照相机，蓝牙，WI-FI，电源管理等等），Android之所以采用Linux，与其特性有关：

* 内核作为一个抽象层存在硬件和软件之间
* 强大的内存管理和进程管理
* 基于权限的安全模式
* 支持共享库
* 经过认证的驱动模式
* Linux本身就是开源项目
* 等等

但同时Android对于Linux进行了改动，比如它没有glibc，最初用于一些便携的移动设备并没有采用glibc作为c库，而是Goolge自己开发的Bionic Libc来作为代替品，也并没有完全照搬Linux系统的内核还增加了Gold-Fish平台以及yaffs2 Flash文件系统，而且它没有了本地基于x服务的窗口系统即Android并没有使用Linux的x窗口，同时还对驱动程序进行了增强显示驱动、键盘驱动、Flash内存驱动、照相机驱动、音频驱动、蓝牙驱动、WiFi驱动、Binder IPC驱动、Power Management（电源管理），包括硬件时钟，内存分配和共享，低内存管理，kernel调试，日志设备，android IPC机制，电源管理等。

#### 驱动

1. Binder IPC驱动：基于OpenBinder框架的一个驱动，用于提供 Android平台的进程间通信功能。源代码位于drivers/staging/android/binder.c
2. 电源管理(PM) ：一个基于标准Linux电源管理系统的轻量级Android电源管理驱动，针对嵌入式设备做了很多优化，比如电池电量。源代码位于：kernel/power/earlysuspend.c、kernel/power/consoleearlysuspend.c、kernel/power/fbearlysuspend.c、kernel/power/wakelock.c、kernel/power/userwakelock.c
3. 低内存管理器：比Linux的标准的OOM机制更加灵活，它可以根据需要杀死进程以释放需要的内存。源代码位于 drivers/staging/ android/lowmemorykiller.c
4. 匿名共享内存： 为进程间提供大块共享内存，同时为内核提供回收和管理这个内存的机制。源代码位于mm/ashmem.c
5. PMEM ：用于向用户空间提供连续的物理内存区域，DSP和某些设备只能工作在连续的物理内存上。源代码位于drivers/misc/pmem.c
6. Logger ：一个轻量级的日志设备，用于抓取Android系统的各种日志。源代码位于drivers/staging/android/logger.c
7. 提供了一个定时器，用于把设备从睡眠状态唤醒，同时它还提供了一个即使在设备睡眠时也会 运行的时钟基准。源代码位于drivers/rtc/alarm
8. USB Gadget：驱动 一个基于标准 Linux USB gadget驱动框架的设备驱动，Android的USB驱动是基于gaeget框 架的。源代码位于drivers/usb/gadget/
9. Ram Console： 为了提供调试功能，Android允许将调试日志信息写入一个被称为RAM Console的设备里，它是一个基于RAM的Buffer。源代码位于drivers/staging/android / ram_console.c
10. timed device： 提供了对设备进行定时控制的功能，目前支持vibrator和LED设备。源代码位于drivers/staging/android /timed_output.c(timed_gpio.c)
11. Yaffs2 ：是文件系统 Android采用Yaffs2作为MTD nand flash文件系统，源代码位于fs/yaffs2/目录下。Yaffs2是一个快速稳定的应用于NAND和NOR Flash的跨平台的嵌入式设备文件系统，同其他Flash文件系统相比，Yaffs2能使用更小的内存来保存其运行状态，因此它占用内存小。Yaffs2的垃圾回收非常简单而且快速，因此能表现出更好的性能。Yaffs2在大容量的NAND Flash上的性能表现尤为突出，非常适合大容量的Flash存储。

### 系统运行库层

通过一些c/c++库来为Android提供主要的特性支持，如SQLite提供了数据库的支持，OpenGL|ES库提供了3D绘图的支持，WebKit库提供了浏览器内核的支持等等。同时在这一层的还有Android运行时库提供了一些核心库，能够允许开发者使用JAVA语言来编写Android应用。还包含了虚拟机Dalvik但之后改为了ART运行环境，使每一个Android应用都有自己的进程，并且都有一个自己的Dalvik虚拟机实例，相较于JAVA的虚拟机Dalvik是专门为移动设备定制的，针对内存和CPU性能都有了优化。

所以Android的系统运行库包含两部分，一个是系统库，另一个是运行时，Android系统的各个组件都在使用c/c++库，这些功能是通过Android应用框架暴露给开发人员的，系统库是应用程序框架的支撑，是连接应用程序框架层与Linux内核层的重要纽带，在程序运行时中执行其运行时分为核心库和Dalvik虚拟机两部分。

#### 系统库

1. Libc：系统c库，是从BSD继承来的标准C系统函数库，专门为基于EmbeddedLinux的设备定制。
2. Media Framework（多媒体库）：Android系统多媒体库，基于PacketVideoOpen、CORE。该库支持录放.并且可以录制许多流行的音频视频格式.还有静态映像文件，包括MPEG4、H.264、MP3、AAC、JPG、PNG等。
3. Surface Manager：主要负责管理针对显示系统的访问，并且为多个应用程序提供2D和3D图层的无缝融合。
4. Webkit：浏览器。一个最新的web浏览器引擎，用来支持Android浏览器和一个可嵌入的Web视图。
5. SGL：一个内置的2D图形引擎。
6. SSL：位于TCP/IP与各种应用层协议之间为数据通信提供支持。
7. OpenGL ES：3D效果的支持。基于OpenGLES 1.0 APIs实现;该库可以使用硬件3D加速或者使用高度优化的3D软加速。
8. greeType：提供位图bitmap和向量vector的字体描述与显示。
9. SQLite：一个对于所有应用程序可用、功能强劲的轻型关系型数据库引擎

除了之上的主要系统类库之外，还有Android NDK，即Android原生库。NDK为开发者提供了直接使用Android系统资源，并采用C 或C++语言编写程序的接口。因此，第三方应用程序可以不依赖于Dalvik虚拟机进行开发。NDK提供了一系列从C或C++生成原生代码所需要的工具，为开发者快速开发 C 或 C++的动态库提供方便，并能自动将生成的动态库和Java 应用程序一起打包成应用程序包文件，即.apk文件。

**注意：使用原生库无法访问应用框架层API，兼容性可能无法保障。而且从安全性角度考虑，Android原生库用非类型安全的程序语言C/C++编写，更容易产生安全漏洞，原生库的缺陷也可能更容易直接影响应用程序的安全性。**

### 应用框架层

这一层主要提供了构建应用程序时可能用到的各种API，Android自带的一些核心应用就是使用这些API完成的。那什么是应用程序框架层，可以说是一个应用程序的核心，是一个共同使用和遵守的约定然后在这个约定上共同扩展，但程序保持主体结构的一致，其作用的是让程序保持清晰在满足不同需求的同时又不互相影响。而对于Android来提供给应用开发者的本身就是一个框架，所有的应用开发都必须遵守这个框架的原则，同时在这个基础上进行扩展可以访问核心应用程序所使用的API框架（即**要实现某个功能就调用安卓系统自己提供的功能，如果不想调用就可以通过继承实现个性化扩展**），安卓的应用框架提供开发Android应用程序所需的一系列类库采用重用机制，开发人员可以进行快速的应用程序开发方便高效的使用安桌平台本身的组件或者替换平台本身的各种应用程序组件。

#### 应用框架

* 活动管理器:管理各个应用程序的生命周期以及通常的导航回退功能。作用：负责一新ActivityThread进程创建，Activity生命周期的维护。
* 窗口管理器：管理所有的窗口程序，在安卓应用框架中窗口主要分为两种:
	* 应用窗口（一个activity有一个主窗口，弹出的对话框也有一个窗口，Menu菜单也是一个窗口。在同一个activity中，主窗口、对话框、Menu窗口之间通过该activity关联起来）。
	* 公共界面的窗口（系统级别的窗口如：最近运行对话框、关机对话框、状态栏下拉栏、锁屏界面等）窗口管理系统是基于C/S模式的。整个窗口系统分为服务端和客户端两大部分，客户端负责请求创建窗口和使用窗口，服务端完成窗口的维护，窗口显示等。

* 内容提供器：使得不同应用程序之间存取或者分享数据。就是可以配置自己的Content Provider去存取其他的应用程序或者通过其他应用程序暴露的Content Provider去存取它们的数据，总的来说就是提供了一个数据共享机制。

* 视图系统:构建应用程序的基本组就是文本框、按钮等。

* 通告管理器:使得应用程序可以在状态栏显示自定义的提示信息，通过NotificationManager 、 Notification这两个类可以完成在状态栏显示提示的信息。

 
* 包管理器：安卓系统内的程序管理，Package Manger是一个实际上管理应用程序安装、卸载和升级的API。当我们安装APK文件时，Package Manager会解析APK包文件和显示确认信息。
     
* 电话管理器:管理所有的移动设备 用于管理手机通话状态、获取电话信息（设备、sim卡、网络信息），监听电话状态以及调用电话拨号器拨打电话。

* 资源管理器:提供应用程序使用的各种非代码资源。提供应用程序使用的各种非代码资源，如本地化字符串、图片、布局文件、颜色文件等
        
* 位置管理器:提供位置服务，LocationManager系统服务是位置服务的核心组件，它提供了一系列方法来处理与位置相关的问题，包括查询上一个已知位置、注册和注销来自某个。LocationProvider的周期性的位置更新、注册和注销接近某个坐标时对一个已定义的Intent的触发等。总的来说就是提供有关位置的操作。
     
* XMPP服务：例如提供Google Talk 服务，XMPP（Extensible Messageing and Presence Protocol：可扩展消息与存在协议）：是一种即时消息协议用于信息的传输。是一种基于XML的开放式实时通信协议，XMPP是基于服务器的也是分散式的

### 应用层

**所有**安装在手机上的应用程序都是这个层，比如手机自带的程序或者下载的游戏（如王者荣耀、崩坏三等）等等。

## 优缺点

### 优势

#### 系统开源

一方面，各个手机厂商无需自行开发手机操作系统，因此纷纷采用Android系统，甚至可以按照自己的目的进行深度定制。另一方面，开源也促进了学习研究社区的迅速兴起，对于开发者来说，相比iOS，开源使得安卓是一个更适合研究与魔改的系统，而不受到不开源系统的限制。

开源带来的一个极大的好处就是手机厂商成本的降低。除却了操作系统开发的高成本，Android厂商的手机价格可以控制在很低的水平；或者在同样价位中相对iOS拥有更高端的硬件配置。因此在中低端市场，安卓有着绝对的统治地位；在高端市场也与iOS有一较之力。

#### 跨平台

由于使用Java进行开发，Android继承了Java跨平台的优点。任何Android应用几乎无需任何修改就能运行于所有的Android设备。这允许各个Android厂商可以自行使用各种各样的硬件设备；而且不仅仅局限于手机，平板，手环，甚至电视和各种智能家居都在使用Android。相比起来iOS的封闭性一定程度上使得iOS的使用范围受到局限。

另一方面，跨平台也极大地方便了庞大的应用开发者群体。同样的应用，对不同的设备编写不同的程序是一件及其浪费劳动力的事情，而Android的出现很好地改善了这一情况。Android在系统运行库层实现了一个硬件抽象层，向上对开发者提供了硬件的抽象，从而实现跨平台，向下也极大地方便了Android系统向各式设备的移植。

#### 丰富的应用

操作系统代表着一个完整的生态圈，一个孤零零的系统，即使设计的再好，没有丰富的应用支持，是很难大规模地流行开的。Android由于一开始的大力推广，以及上述几项很适宜流行的特点，使得Android在一开始就吸引了很多开发者，时至今日，Android已经积累了相当多的应用，更多的应用使得Android更加流行，从而吸引更多的开发者开发更多更好的应用，形成一个良性循环。

**华为笔记本上使用的Deepin系统就由于生态应用的局限性导致许多想尝试新系统的人不得不改装Windows。**

#### Google强大的技术支持

虽然Google对于中国而言不是一家好公司。但不可否认的是Google是一家强大的公司。

Google让Android变得越来越强大，进而快速流行。Google丰厚的技术实力，让Android可以迅速用上谷歌地图、Chrome浏览器、Google Now语音命令等优质服务；Google的互联网身份和强大号召力，让Android能在短期内吸引到运营商、制造商和开发者的支持；Google强大的开发能力也保证了Android有着持续有效的产品迭代，使其不断完善。 

### 劣势

#### 跨平台一定程度上牺牲了性能

由于使用虚拟机技术，Android在性能上是有一些劣势的。在很长一段时间Android使用自主研发的Dalvik虚拟机提供应用程序框架支持并运行各种应用程序。**在以前的Android系统上**，所有的应用程序都是运行在Dalvik中。虽说优点在于这种机制可以让各种各样的应用程序运行在多种硬件架构上，但应用程序每次运行时其中一部分代码都要需要机器重新编译。这个过程即消耗时间又要消耗系统资源，所以执行效率难免会降低。

同时，由于**Android支持各种不同的硬件**，与环境单一的iOS比起来，兼容性会带来性能的牺牲。由于版权问题，很多硬件的驱动并没有放在linux内核层而是放在了用户态，这也一定程度上牺牲了性能。

然而Android的运行性能正在得到逐步改善。**从Android 5.0开始**Dalvik虚拟机将会被彻底废弃，**改为使用ART运行环境**。相比Dalvik，ART的处理机制完全不同，它会在应用程序安装时就把程序代码转换成机器语言，让程序成为真正的本地应用。这样做的好处是程序的启动时间被极大的提高，运行速度也会更快。电量消耗的更少，系统运行也跟着更加流畅。

#### 应用水平安全性

由于在推广早起致力于Android的迅速流行，Android**应用的编写的门槛被降得很低，权限管理方面的机制很不完善**，这就导致Android系统的安全性常被人诟病。iOS由于系统有着极其严格的权限管理，加上Apple Store对发布的应用的审查，其安全性往往能够得到很好的保障。

另一方面，**Android是开源**的，相较于iOS，这也使得一些攻击的黑客更加轻易找到漏洞。